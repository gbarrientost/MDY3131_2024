----CASO2 FORMA 1

SET SERVEROUTPUT ON;
VAR B_ANNIO NUMBER
EXEC :B_ANNIO := TO_CHAR(SYSDATE,'MMYYYY');

VAR B_RUN NUMBER
EXEC :B_RUN := 12648200;

--ESTADOS CIVILES
VAR B_EST1 VARCHAR2 
EXEC :B_EST1:='CASADO'

VAR B_EST2 VARCHAR2 
EXEC :B_EST2:='ACUERDO DE UNION CIVIL'

VAR B_EST3 VARCHAR2 
EXEC :B_EST3:='DIVORCIADO'

VAR B_EST4 VARCHAR2 
EXEC :B_EST4:='SOLTERO'

VAR B_EST5 VARCHAR2 
EXEC :B_EST5:='VIUDO'

VAR B_EST6 VARCHAR2 
EXEC :B_EST6:='SEPARADO'





DECLARE

  V_NUMRUN_EMP USUARIO_CLAVE.NUMRUN_EMP%TYPE;
  V_DVRUN_EMP USUARIO_CLAVE.DVRUN_EMP%TYPE;
  V_NOMBRE_EMPLEADO USUARIO_CLAVE.NOMBRE_EMPLEADO%TYPE;
  V_NOMBRE_USUARIO USUARIO_CLAVE.NOMBRE_USUARIO%TYPE;
  V_CLAVE_USUARIO USUARIO_CLAVE.CLAVE_USUARIO%TYPE;
  V_ANNOS_CONTRATO NUMBER;
  V_SUELDO_BASE EMPLEADO.SUELDO_BASE%TYPE;
  V_PRIMER_NOMBRE VARCHAR2(25);
  V_ESTADO_CIVIL ESTADO_CIVIL.NOMBRE_ESTADO_CIVIL%TYPE;
  V_COMUNA COMUNA.NOMBRE_COMUNA%TYPE;
  V_APPATERNO_LETRAS VARCHAR2(2);
  V_APPATERNO_EMP EMPLEADO.APPATERNO_EMP%TYPE;
  V_FECHA_NAC EMPLEADO.FECHA_NAC%TYPE;



BEGIN

   

  SELECT
    NUMRUN_EMP,DVRUN_EMP,
    PNOMBRE_EMP||' '||SNOMBRE_EMP||' '||APPATERNO_EMP||' '||APMATERNO_EMP,
    SUELDO_BASE,
    ROUND(MONTHS_BETWEEN(SYSDATE, FECHA_CONTRATO)/12),
    EC.NOMBRE_ESTADO_CIVIL,
    C.NOMBRE_COMUNA,
    APPATERNO_EMP,
    FECHA_NAC
  INTO 
    V_NUMRUN_EMP, 
    V_DVRUN_EMP, 
    V_NOMBRE_EMPLEADO, 
    V_SUELDO_BASE, 
    V_ANNOS_CONTRATO, 
    V_ESTADO_CIVIL, 
    V_COMUNA,
    V_APPATERNO_EMP,
    V_FECHA_NAC
  FROM EMPLEADO E 
  INNER JOIN COMUNA C ON (E.ID_COMUNA = C.ID_COMUNA)
  INNER JOIN ESTADO_CIVIL EC ON (E.ID_ESTADO_CIVIL = EC.ID_ESTADO_CIVIL)
  WHERE NUMRUN_EMP = :B_RUN;

 
  V_PRIMER_NOMBRE := SUBSTR(V_NOMBRE_EMPLEADO, 1, INSTR(V_NOMBRE_EMPLEADO, ' ') - 1);--extrae una subcadena de la cadena V_NOMBRE_EMPLEADO desde el primer carácter hasta el carácter antes del primer espacio en blanco

   
  --AÑOS CONTRATADOS

  IF V_ANNOS_CONTRATO < 10 THEN

    V_NOMBRE_USUARIO := SUBSTR(V_NOMBRE_EMPLEADO,0,3)||LENGTH(V_PRIMER_NOMBRE)||'*'||SUBSTR(V_SUELDO_BASE,-1)||V_DVRUN_EMP||V_ANNOS_CONTRATO||'X';

  ELSE

    V_NOMBRE_USUARIO := SUBSTR(V_NOMBRE_EMPLEADO,0,3)||LENGTH(V_PRIMER_NOMBRE)||'*'||SUBSTR(V_SUELDO_BASE,-1)||V_DVRUN_EMP||V_ANNOS_CONTRATO;

  END IF;

   

  --ESTADOS CIVILES

  IF V_ESTADO_CIVIL = :B_EST1 OR V_ESTADO_CIVIL = :B_EST2 THEN
    V_APPATERNO_LETRAS := LOWER(SUBSTR(V_APPATERNO_EMP,1,2));
     
  ELSIF V_ESTADO_CIVIL = :B_EST3 OR V_ESTADO_CIVIL = :B_EST4 THEN
    V_APPATERNO_LETRAS := LOWER(SUBSTR(V_APPATERNO_EMP,1,1)||SUBSTR(V_APPATERNO_EMP,-1,1));
   
  ELSIF V_ESTADO_CIVIL = :B_EST5 THEN
    V_APPATERNO_LETRAS := LOWER(SUBSTR(V_APPATERNO_EMP,-3,2));

     
  ELSIF V_ESTADO_CIVIL = :B_EST6 THEN
    V_APPATERNO_LETRAS := LOWER(SUBSTR(V_APPATERNO_EMP,-2,2));

  ELSE

     V_APPATERNO_LETRAS := NULL;

     

  END IF;

   

  V_CLAVE_USUARIO := SUBSTR(V_NUMRUN_EMP,3,1) || EXTRACT(YEAR FROM V_FECHA_NAC) + 2 || 
            SUBSTR(V_SUELDO_BASE, -3, 3) - 1 || V_APPATERNO_LETRAS ||
            :B_ANNIO || SUBSTR(V_COMUNA,1,1);
   

  DBMS_OUTPUT.PUT_LINE('MES Y AÑO: ' || :B_ANNIO);
  DBMS_OUTPUT.PUT_LINE('RUT EMPLEADO: ' || V_NUMRUN_EMP ||'-'||V_DVRUN_EMP);
  DBMS_OUTPUT.PUT_LINE('NOMBRE EMPLEADO: ' || V_NOMBRE_EMPLEADO);
  DBMS_OUTPUT.PUT_LINE('NOMBRE USUARIO: ' || V_NOMBRE_USUARIO);
  DBMS_OUTPUT.PUT_LINE('CLAVE USUARIO: ' || V_CLAVE_USUARIO);

INSERT INTO USUARIO_CLAVE (MES_ANNO,NUMRUN_EMP,DVRUN_EMP,NOMBRE_EMPLEADO,
NOMBRE_USUARIO,CLAVE_USUARIO)VALUES(:B_ANNIO,V_NUMRUN_EMP,V_DVRUN_EMP,
V_NOMBRE_EMPLEADO,V_NOMBRE_USUARIO,V_CLAVE_USUARIO);
COMMIT;

END;
