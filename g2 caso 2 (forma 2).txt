
--CASO2 FORMA 2
SET SERVEROUTPUT ON;

VAR B_RUT NUMBER;
EXEC :B_RUT := 12642309;

DECLARE
V_MES_ANNO USUARIO_CLAVE.MES_ANNO%TYPE;
V_NUMRUN_EMP USUARIO_CLAVE.NUMRUN_EMP%TYPE;
V_DVRUN_EMP USUARIO_CLAVE.DVRUN_EMP%TYPE;
V_NOMBRE_EMPLEADO USUARIO_CLAVE.NOMBRE_EMPLEADO%TYPE;
V_NOMBRE_USUARIO USUARIO_CLAVE.NOMBRE_USUARIO%TYPE;
V_CLAVE_USUARIO USUARIO_CLAVE.CLAVE_USUARIO%TYPE;

BEGIN
    
    SELECT
    TO_CHAR(SYSDATE, 'MMYYYY'),
    DVRUN_EMP,
    PNOMBRE_EMP ||' '||SNOMBRE_EMP||' '||APPATERNO_EMP||' '||APMATERNO_EMP
    INTO V_MES_ANNO, V_DVRUN_EMP, V_NOMBRE_EMPLEADO
    FROM EMPLEADO
    WHERE NUMRUN_EMP = :B_RUT;
    
   
   SELECT 
   SUBSTR(PNOMBRE_EMP,1,3) || LENGTH(PNOMBRE_EMP) || '*' || SUBSTR(SUELDO_BASE,-1,1) || V_DVRUN_EMP || ROUND (MONTHS_BETWEEN(SYSDATE, FECHA_CONTRATO)/12) ||
   CASE 
   WHEN ROUND (MONTHS_BETWEEN(SYSDATE, FECHA_CONTRATO)/12) < 10 THEN 'X'
   END
   INTO V_NOMBRE_USUARIO
   FROM EMPLEADO
   WHERE NUMRUN_EMP = :B_RUT ; --AGREGAR LO DE MENOS DE 10 AÃ‘OS
   
    SELECT
   SUBSTR(E.NUMRUN_EMP,3,1) || EXTRACT(YEAR FROM E.FECHA_NAC)+2 || SUBSTR(E.SUELDO_BASE, -3, 3)-1 || 
   LOWER(CASE
    WHEN E.ID_ESTADO_CIVIL = 10 OR E.ID_ESTADO_CIVIL = 60 THEN SUBSTR(E.APPATERNO_EMP, 1,2)
    WHEN E.ID_ESTADO_CIVIL = 20 OR E.ID_ESTADO_CIVIL = 30 THEN SUBSTR(E.APPATERNO_EMP, 1,1)||SUBSTR(E.APPATERNO_EMP, -1,1)
    WHEN E.ID_ESTADO_CIVIL = 40 THEN SUBSTR(E.APPATERNO_EMP, -3,2)
    WHEN E.ID_ESTADO_CIVIL = 50 THEN SUBSTR(E.APPATERNO_EMP, -1,2)
   END) ||
   EXTRACT(MONTH FROM SYSDATE) || EXTRACT(YEAR FROM SYSDATE) ||
   SUBSTR(C.NOMBRE_COMUNA,1,1)
   INTO V_CLAVE_USUARIO
   FROM EMPLEADO E
   INNER JOIN COMUNA C ON C.ID_COMUNA = E.ID_COMUNA
   WHERE NUMRUN_EMP = :B_RUT; 
    
    DBMS_OUTPUT.PUT_LINE(V_MES_ANNO);
    DBMS_OUTPUT.PUT_LINE(V_NOMBRE_EMPLEADO);
    DBMS_OUTPUT.PUT_LINE(:b_rut);
    DBMS_OUTPUT.PUT_LINE(V_DVRUN_EMP);
    DBMS_OUTPUT.PUT_LINE(V_NOMBRE_USUARIO);
    DBMS_OUTPUT.PUT_LINE(V_CLAVE_USUARIO);
    
    INSERT INTO USUARIO_CLAVE (MES_ANNO,NUMRUN_EMP,DVRUN_EMP,NOMBRE_EMPLEADO,
NOMBRE_USUARIO,CLAVE_USUARIO)VALUES(V_MES_ANNO,V_NUMRUN_EMP,V_DVRUN_EMP,
V_NOMBRE_EMPLEADO,V_NOMBRE_USUARIO,V_CLAVE_USUARIO);
COMMIT;
END;